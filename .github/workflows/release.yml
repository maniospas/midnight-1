name: Build Artifacts

on:
  push:

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    # =========================================================
    # LINUX
    # =========================================================
    - name: Install deps (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt update
        sudo apt install -y \
          g++ make git zip \
          libx11-dev libxrandr-dev libxinerama-dev \
          libxcursor-dev libxi-dev libgl1-mesa-dev

    - name: Build raylib (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        git clone --depth 1 https://github.com/raysan5/raylib.git
        cd raylib/src
        make PLATFORM=PLATFORM_DESKTOP
        sudo make install
        sudo ldconfig

    - name: Build game (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: make

    - name: Package (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        mkdir release
        cp game release/
        cp -r data release/
        ldd game | grep "=> /" | awk '{print $3}' | xargs -I{} cp {} release/
        zip -r "midnight next morn-linux.zip" release

    - uses: actions/upload-artifact@v4
      if: matrix.os == 'ubuntu-latest'
      with:
        name: game-linux
        path: "midnight next morn-linux.zip"

    # =========================================================
    # WINDOWS
    # =========================================================
    - name: Install deps (Windows)
      if: matrix.os == 'windows-latest'
      run: vcpkg install raylib:x64-windows
      shell: pwsh

    - name: Build game (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        g++ -std=c++17 -O2 -Wall main.cpp -o game.exe ^
          -IC:/vcpkg/installed/x64-windows/include ^
          -LC:/vcpkg/installed/x64-windows/lib ^
          -lraylib -lopengl32 -lgdi32 -lwinmm
      shell: cmd

    - name: Package (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        mkdir release
        copy game.exe release\
        xcopy /E /I data release\data
        copy C:\vcpkg\installed\x64-windows\bin\*.dll release\
        tar -a -c -f "midnight next morn-windows.zip" release
      shell: cmd

    - uses: actions/upload-artifact@v4
      if: matrix.os == 'windows-latest'
      with:
        name: game-windows
        path: "midnight next morn-windows.zip"

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v4
      with:
        path: artifacts

    - uses: softprops/action-gh-release@v2
      with:
        tag_name: snapshot
        name: Snapshot Build
        prerelease: true
        files: |
          artifacts/game-linux/midnight next morn-linux.zip
          artifacts/game-windows/midnight next morn-windows.zip
